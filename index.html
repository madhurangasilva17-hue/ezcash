<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EzCash</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#f5f7fb;
}

.container{ padding:15px; }

.welcome{
  background:#d9e6f2;
  padding:20px;
  border-radius:20px;
  margin-bottom:15px;
}

.row{
  display:flex;
  gap:10px;
  margin-bottom:15px;
}

.card-small{
  flex:1;
  background:#fff;
  padding:15px;
  border-radius:18px;
  box-shadow:0 3px 10px rgba(0,0,0,0.05);
}

.value{
  font-size:20px;
  font-weight:bold;
  margin-top:5px;
}

.blue{ color:#1e88e5; }
.green{ color:#2e7d32; }

.card{
  background:#fff;
  padding:15px;
  border-radius:18px;
  box-shadow:0 3px 10px rgba(0,0,0,0.05);
  margin-bottom:15px;
}

.progress{
  height:6px;
  background:#ddd;
  border-radius:10px;
  margin:10px 0;
}

.progress-fill{
  height:6px;
  background:#1e88e5;
  border-radius:10px;
  width:0%;
}

.btn{
  width:100%;
  padding:10px;
  border:none;
  border-radius:10px;
  background:#1e88e5;
  color:white;
  font-weight:bold;
  margin-top:10px;
  cursor:pointer;
}

.badge{
  background:#e3f2fd;
  color:#1e88e5;
  padding:5px 10px;
  border-radius:20px;
  font-size:12px;
  float:right;
}

.note{
  font-size:13px;
  margin-top:5px;
  color:#777;
}
</style>
</head>

<body>

<div class="container">

  <div class="welcome">
    <h2 id="username">Welcome ðŸ‘‹</h2>
    <p>Complete tasks to earn rewards</p>
  </div>

  <div class="row">
    <div class="card-small">
      <div>Total Earnings</div>
      <div class="value blue" id="balance">0 LKR</div>
    </div>

    <div class="card-small">
      <div>Referrals</div>
      <div class="value green" id="referrals">0</div>
    </div>
  </div>

  <div class="card">
    <h3>Daily Progress</h3>
    <div class="progress">
      <div class="progress-fill" id="progBar"></div>
    </div>
    <p id="progressText">0 / 30 completed</p>
    <button class="btn" onclick="earn()">Watch Ad (+100 LKR)</button>
  </div>

  <div class="card">
    <span class="badge">200 LKR / referral</span>
    <h3>Refer & Earn</h3>
    <p>Your Referral Link:</p>
    <div id="refLinkBox" style="word-break:break-all;"></div>
    <button class="btn" onclick="copyRef()">Copy Link</button>
  </div>

  <div class="card">
    <h3>Withdraw</h3>
    <input id="wdAmount" type="number" placeholder="Enter amount" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;">
    <p class="note" id="wdNote"></p>
    <button class="btn" onclick="withdraw()">Request Withdraw</button>
  </div>

</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const user = tg.initDataUnsafe?.user;
const API_URL = "http://localhost:3000";

let me = { balance:0, referrals:0, ads:0 };
let dailyTotal = 30;

function $(id){ return document.getElementById(id); }

function tgAlert(text){
  if(tg?.showAlert) tg.showAlert(text);
  else alert(text);
}

function money(v){ return v + " LKR"; }

async function loadMe(){
  if(!user?.id) return;

  const res = await fetch(API_URL + "/user/" + user.id);
  me = await res.json();

  $("username").innerText = "Welcome Back, " + user.first_name + " ðŸ‘‹";
  $("balance").innerText = money(me.balance);
  $("referrals").innerText = me.referrals || 0;
  $("refLinkBox").innerText =
    "https://t.me/YOUR_BOT_USERNAME?start=" + user.id;

  updateWithdrawNote();
  renderProgress();
}

function renderProgress(){
  const pct = Math.min(100, (me.ads / dailyTotal) * 100);
  $("progBar").style.width = pct + "%";
  $("progressText").innerText =
    me.ads + " / " + dailyTotal + " completed";
}

function updateWithdrawNote(){
  if((me.referrals || 0) >= 15)
    $("wdNote").innerText =
      "âœ… You can request withdrawal";
  else
    $("wdNote").innerText =
      "âš  Need at least 15 referrals";
}

async function earn(){
  if(me.ads >= dailyTotal)
    return tgAlert("Daily limit reached");

  const res = await fetch(API_URL + "/watch-ad",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ userId:user.id })
  });

  me = await res.json();
  $("balance").innerText = money(me.balance);
  renderProgress();
}

async function withdraw(){
  const amount = Number($("wdAmount").value);
  if(!amount) return tgAlert("Enter amount");

  if(me.referrals < 15)
    return tgAlert("Need 15 referrals");

  const res = await fetch(API_URL + "/withdraw",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ userId:user.id, amount })
  });

  const data = await res.json();
  if(data.ok){
    me.balance = data.balance;
    $("balance").innerText = money(me.balance);
    tgAlert("Withdraw requested");
  } else {
    tgAlert(data.error || "Error");
  }
}

function copyRef(){
  navigator.clipboard.writeText($("refLinkBox").innerText);
  tgAlert("Copied");
}

loadMe();
</script>

</body>
</html>
