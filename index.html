<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EzCash</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6fb;}
.container{padding:16px;}
.card{background:#fff;padding:20px;border-radius:16px;margin-bottom:16px;}
.btn{width:100%;padding:12px;border:none;border-radius:12px;background:#1e88e5;color:#fff;font-weight:bold;cursor:pointer;}
</style>
</head>

<body>

<div class="container">

  <div class="card">
    <h3 id="username">Welcome</h3>
  </div>

  <div class="card">
    <h3>Total Earnings</h3>
    <div id="balance">0.00 LKR</div>
  </div>

  <div class="card">
    <button class="btn" onclick="earn()">Watch Ad (+100 LKR)</button>
  </div>

  <div class="card">
    <button class="btn" onclick="copyRef()">Copy Referral Link</button>
  </div>

</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const API_URL = "https://ezcash-1.onrender.com";
const ADSGRAM_BLOCK_ID = "23197"; // ðŸ”´ Put your real block ID

let user = tg.initDataUnsafe?.user;
let me = { balance:0 };

// Dynamic AdsGram loader
(function () {
  const s = document.createElement("script");
  s.src = "https://adsgram.ai/sdk.js";
  s.async = true;
  s.onload = function () {
    console.log("AdsGram Loaded");
  };
  s.onerror = function () {
    console.log("AdsGram failed to load");
  };
  document.head.appendChild(s);
})();

window.onload = async function(){

  if(!user){
    alert("Open inside Telegram");
    return;
  }

  document.getElementById("username").innerText =
    "Welcome, " + user.first_name;

  loadUser();
};

async function loadUser(){
  const res = await fetch(API_URL + "/user/" + user.id);
  me = await res.json();
  document.getElementById("balance").innerText =
    me.balance.toFixed(2) + " LKR";
}

async function earn(){

  if (!window.Adsgram || !window.Adsgram.showRewarded) {
    alert("Ads not ready yet");
    return;
  }

  try {
    await window.Adsgram.showRewarded({
      blockId: ADSGRAM_BLOCK_ID,
      userId: String(user.id)
    });

    setTimeout(loadUser, 2000);

  } catch(e){
    alert("Ad not completed");
  }
}

function copyRef(){
  const link = "https://t.me/ezcash_lk_bot?start=" + user.id;

  navigator.clipboard.writeText(link)
    .then(()=> alert("Copied âœ…"))
    .catch(()=> alert(link));
}
</script>

</body>
</html>
